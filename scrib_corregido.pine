//@version=6
indicator("Divergencias RSI/MACD + OrderBlock Zonas", overlay=true)

// === INPUTS ===
rsiLen = input.int(5, title="RSI Length")
macdFast = input.int(8, title="MACD Fast")
macdSlow = input.int(21, title="MACD Slow")
macdSignal = input.int(5, title="MACD Signal")
obZoneLen = input.int(20, title="OrderBlock Zona Longitud", minval=1)

// === INDICADORES BASE ===
rsi = ta.rsi(close, rsiLen)
macdLine = ta.ema(close, macdFast) - ta.ema(close, macdSlow)
macdSignalLine = ta.ema(macdLine, macdSignal)

// === PIVOTS PARA DETECTAR DIVERGENCIAS ===
// Reducir lookback para evitar error de datos históricos
pivotLookback = 3
pivHigh = ta.pivothigh(close, pivotLookback, pivotLookback)
pivLow = ta.pivotlow(close, pivotLookback, pivotLookback)
rsiHigh = ta.pivothigh(rsi, pivotLookback, pivotLookback)
rsiLow = ta.pivotlow(rsi, pivotLookback, pivotLookback)
macdHigh = ta.pivothigh(macdLine, pivotLookback, pivotLookback)
macdLow = ta.pivotlow(macdLine, pivotLookback, pivotLookback)

// === DIVERGENCIAS ===
// Alcista: precio hace low más bajo, RSI o MACD hace low más alto
// Añadir verificación para evitar índices inválidos
divRSIBull = false
divMACDBull = false

if not na(pivLow) and not na(rsiLow)
    if pivLow < 100 and rsiLow < 100  // Limitar búsqueda atrás
        divRSIBull := close[pivLow] < close and rsi[rsiLow] > rsi

if not na(pivLow) and not na(macdLow)
    if pivLow < 100 and macdLow < 100
        divMACDBull := close[pivLow] < close and macdLine[macdLow] > macdLine

bullishDiv = divRSIBull or divMACDBull

// Bajista: precio hace high más alto, RSI o MACD hace high más bajo
divRSIBear = false
divMACDBear = false

if not na(pivHigh) and not na(rsiHigh)
    if pivHigh < 100 and rsiHigh < 100
        divRSIBear := close[pivHigh] > close and rsi[rsiHigh] < rsi

if not na(pivHigh) and not na(macdHigh)
    if pivHigh < 100 and macdHigh < 100
        divMACDBear := close[pivHigh] > close and macdLine[macdHigh] < macdLine

bearishDiv = divRSIBear or divMACDBear

// === ZONAS ORDERBLOCK SIMULADAS ===
obHigh = ta.highest(high, obZoneLen)
obLow = ta.lowest(low, obZoneLen)
inOverbought = close >= obHigh
inOversold = close <= obLow

// === FILTRAR DIVERGENCIAS SOLO EN ZONAS CLAVE ===
validBullSignal = bullishDiv and inOversold
validBearSignal = bearishDiv and inOverbought

// === PLOTEO Y ALERTAS ===
plotshape(validBullSignal, title="Alerta Compra", location=location.belowbar, color=color.green, style=shape.labelup, text="Buy")
plotshape(validBearSignal, title="Alerta Venta", location=location.abovebar, color=color.red, style=shape.labeldown, text="Sell")

alertcondition(validBullSignal, title="Alerta Divergencia Alcista", message="¡Divergencia Alcista detectada!")
alertcondition(validBearSignal, title="Alerta Divergencia Bajista", message="¡Divergencia Bajista detectada!")
