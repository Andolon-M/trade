//@version=6
indicator("Divergencias RSI/MACD Avanzado", overlay=true)

// === INPUTS ===
rsiLen = input.int(14, title="RSI Length", minval=1)
macdFast = input.int(12, title="MACD Fast", minval=1)
macdSlow = input.int(26, title="MACD Slow", minval=1)
macdSignal = input.int(9, title="MACD Signal", minval=1)
obZoneLen = input.int(20, title="Zona OB/OS Length", minval=1)
rsiOverbought = input.int(90, title="RSI Sobrecompra", minval=50, maxval=100)
rsiOversold = input.int(10, title="RSI Sobreventa", minval=0, maxval=50)

// === INDICADORES BASE ===
rsi = ta.rsi(close, rsiLen)
[macdLine, signalLine, histLine] = ta.macd(close, macdFast, macdSlow, macdSignal)

// === ZONAS OB/OS ===
highLevel = ta.highest(high, obZoneLen)
lowLevel = ta.lowest(low, obZoneLen)
isOverbought = close >= highLevel * 0.995  // 99.5% del máximo
isOversold = close <= lowLevel * 1.005     // 100.5% del mínimo

// === SEÑALES SIMPLES BASADAS EN CRUCES ===
rsiOverboughtSignal = ta.crossunder(rsi, rsiOverbought)
rsiOversoldSignal = ta.crossover(rsi, rsiOversold)
macdCrossOverSignal = ta.crossover(macdLine, signalLine)
macdCrossUnderSignal = ta.crossunder(macdLine, signalLine)

// === PIVOTS PARA DETECTAR DIVERGENCIAS ===
// Reducir lookback para evitar error de datos históricos
pivotLookback = 3
pivHigh = ta.pivothigh(close, pivotLookback, pivotLookback)
pivLow = ta.pivotlow(close, pivotLookback, pivotLookback)
rsiHigh = ta.pivothigh(rsi, pivotLookback, pivotLookback)
rsiLow = ta.pivotlow(rsi, pivotLookback, pivotLookback)
macdHigh = ta.pivothigh(macdLine, pivotLookback, pivotLookback)
macdLow = ta.pivotlow(macdLine, pivotLookback, pivotLookback)

// === DIVERGENCIAS ===
// Alcista: precio hace low más bajo, RSI o MACD hace low más alto
// Añadir verificación para evitar índices inválidos
divRSIBull = false
divMACDBull = false

if not na(pivLow) and not na(rsiLow)
    if pivLow < 100 and rsiLow < 100  // Limitar búsqueda atrás
        divRSIBull := close[pivLow] < close and rsi[rsiLow] > rsi

if not na(pivLow) and not na(macdLow)
    if pivLow < 100 and macdLow < 100
        divMACDBull := close[pivLow] < close and macdLine[macdLow] > macdLine

bullishDiv = divRSIBull or divMACDBull

// Bajista: precio hace high más alto, RSI o MACD hace high más bajo
divRSIBear = false
divMACDBear = false

if not na(pivHigh) and not na(rsiHigh)
    if pivHigh < 100 and rsiHigh < 100
        divRSIBear := close[pivHigh] > close and rsi[rsiHigh] < rsi

if not na(pivHigh) and not na(macdHigh)
    if pivHigh < 100 and macdHigh < 100
        divMACDBear := close[pivHigh] > close and macdLine[macdHigh] < macdLine

bearishDiv = divRSIBear or divMACDBear

// === COMBINAR TODAS LAS SEÑALES ===
// Señal de compra: (RSI cruzando sobre nivel sobreventa o MACD cruzando sobre línea de señal) y en zona sobreventa
// O divergencia alcista en zona sobreventa
buyRSISignal = rsiOversoldSignal and isOversold
buyMACDSignal = macdCrossOverSignal and isOversold
buyDivergenceSignal = bullishDiv and isOversold
buySignal = buyRSISignal or buyMACDSignal or buyDivergenceSignal

// Señal de venta: (RSI cruzando bajo nivel sobrecompra o MACD cruzando bajo línea de señal) y en zona sobrecompra
// O divergencia bajista en zona sobrecompra
sellRSISignal = rsiOverboughtSignal and isOverbought
sellMACDSignal = macdCrossUnderSignal and isOverbought
sellDivergenceSignal = bearishDiv and isOverbought
sellSignal = sellRSISignal or sellMACDSignal or sellDivergenceSignal

// === VISUALIZACIÓN ===
// Señales
plotshape(buySignal, title="Señal de Compra", location=location.belowbar, 
     color=color.green, style=shape.labelup, size=size.normal, text="BUY")
plotshape(sellSignal, title="Señal de Venta", location=location.abovebar, 
     color=color.red, style=shape.labeldown, size=size.normal, text="SELL")

// Indicadores de zonas
bgcolor(isOverbought ? color.new(color.red, 95) : na)
bgcolor(isOversold ? color.new(color.green, 95) : na)

// === ALERTAS ===
alertcondition(buySignal, title="Alerta de Compra", message="¡Señal de compra detectada!")
alertcondition(sellSignal, title="Alerta de Venta", message="¡Señal de venta detectada!")
